

## Корневая причина: почему платформа "загружается вечно"

### Что происходит сейчас при открытии платформы

1. Пользователь открывает страницу
2. `useAuth` проверяет сессию + загружает профиль + загружает роль (3 запроса к Supabase, ~1-2 сек)
3. `ProtectedRoute` показывает спиннер пока auth грузится -- это OK
4. Auth загрузился --> `Index.tsx` рендерится --> **страница показывается с пустыми данными**
5. `useEffect` в `Index.tsx` запускает `externalDb.batch()` --> запрос к edge-функции
6. Edge-функция **холодный старт** (в логах видно: isolate boot ~30ms, но TCP-подключение к PostgreSQL в РФ занимает 2-10 сек)
7. Пока batch грузится -- пользователь видит пустую платформу, думает что она "зависла"
8. Если запрос провалился (таймаут, сбой сети) -- **никакой ошибки не показывается**, данные просто не приходят

### Три системные проблемы

**Проблема 1: Нет индикатора загрузки данных**

`Index.tsx` имеет состояние `dataLoaded`, но оно **нигде не используется** в UI. Страница рендерится мгновенно с пустыми initial-данными, пользователь видит "пустоту" и думает что приложение сломалось.

**Проблема 2: Нет обработки ошибок загрузки**

Если batch-запрос упал (таймаут, сеть, ошибка БД), `catch` просто пишет в console.error и ставит `dataLoaded = true`. Пользователь видит пустую платформу без возможности перезагрузить данные.

**Проблема 3: Гонка состояний в useAuth**

`onAuthStateChange` и `getSession` запускаются параллельно. `getSession` НЕ загружает `profileName` (только роль). Если `getSession` завершится первым -- `loading` станет `false`, Index начнёт рендер, но `profileName` ещё не загружен. Потом `onAuthStateChange` перезапишет всё заново, вызывая двойной batch-запрос.

## План исправления

### Шаг 1. Добавить загрузочный экран в Index.tsx

Пока `dataLoaded === false`, показывать красивый спиннер вместо пустого контента. Это мгновенно решает "ощущение зависания" -- пользователь видит, что данные загружаются.

Также добавить состояние `loadError` -- если batch упал, показывать кнопку "Повторить".

### Шаг 2. Исправить гонку в useAuth

Убрать дублирование: `getSession` должен вызываться ТОЛЬКО для инициализации, а `onAuthStateChange` обрабатывает все последующие изменения. Загрузка профиля и роли должна происходить в одном месте, а не в двух.

Конкретно:
- Вынести общую функцию `loadUserData(session)` которая грузит профиль + роль
- `getSession` вызывает её при старте
- `onAuthStateChange` вызывает её при изменениях
- Использовать флаг чтобы `setLoading(false)` вызывался только ОДИН раз

### Шаг 3. Добавить profileName в getSession

Сейчас `getSession` загружает роль, но не имя. Из-за этого при первом рендере Index показывает "Пользователь" вместо имени.

## Затронутые файлы

### `src/hooks/useAuth.tsx`
- Вынести `loadUserData(session)` -- единая функция для загрузки профиля + роли
- Исключить гонку: `setLoading(false)` вызывается ровно один раз
- `getSession` тоже загружает `profileName`

### `src/pages/Index.tsx`
- Добавить состояние `loadError`
- Пока `!dataLoaded && !loadError` -- показывать спиннер с текстом "Загрузка данных..."
- При `loadError` -- показывать сообщение + кнопку "Повторить"
- Вынести функцию `loadData()` из useEffect чтобы её можно было вызвать повторно

## Ожидаемый результат

- Пользователь ВСЕГДА видит обратную связь: либо спиннер, либо данные, либо кнопку "повторить"
- Нет "пустых экранов" и ощущения зависания
- Нет двойных запросов из-за гонки auth
- При сбое сети -- возможность перезагрузить без обновления страницы
