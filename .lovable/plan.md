

## Проблема: повторная загрузка после открытия файлов

### Цепочка событий

```text
Клик "Открыть файл"
  -> supabase.storage.createSignedUrl()  (API-запрос к Supabase)
  -> Supabase-клиент обновляет токен (если близок к истечению)
  -> onAuthStateChange('TOKEN_REFRESHED', newSession)
  -> loadUserData(newSession)
  -> setUser(newSession.user)  // НОВЫЙ объект, хотя user_id тот же
  -> useCallback(loadData, [user]) получает новую ссылку
  -> useEffect([loadData]) срабатывает заново
  -> setDataLoaded(false) -> спиннер "Загрузка данных..."
```

### Решение: стабилизировать ссылку на user

Два изменения, которые разрывают эту цепочку:

#### 1. `src/hooks/useAuth.tsx` -- не обновлять user, если ID не изменился

В `loadUserData` заменить безусловный `setUser(sess.user)` на проверку: если текущий `user.id` совпадает с новым, не вызывать `setUser`. Это предотвращает создание новой ссылки на объект при обновлении токена.

Для доступа к текущему значению user без добавления его в зависимости используем `useRef`.

#### 2. `src/pages/Index.tsx` -- не сбрасывать dataLoaded при повторной загрузке

Изменить `loadData`: если данные уже загружены (`dataLoaded === true`), не показывать спиннер при фоновом обновлении. Добавить флаг `isInitialLoad` через `useRef`, чтобы спиннер показывался только при первом запуске.

### Затронутые файлы

- `src/hooks/useAuth.tsx` -- стабилизация `setUser` по ID
- `src/pages/Index.tsx` -- не сбрасывать `dataLoaded` при повторных вызовах `loadData`

### Результат

- Обновление токена при открытии файлов больше не вызывает перезагрузку данных
- Спиннер показывается только при первом открытии платформы
- Файлы продолжают открываться корректно

