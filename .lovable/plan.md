

## Исправление: файлы открываются как about:blank

### Диагностика

Проблема НЕ в свежести токена (добавление `ensureFreshToken` не помогло). Анализ выявил несколько возможных причин:

1. **`createSignedUrl` возвращает ошибку** -- toast показывается на ОРИГИНАЛЬНОЙ вкладке, а пользователь смотрит на новую вкладку с about:blank. `newWindow.close()` не срабатывает в некоторых браузерах.
2. **Избыточный вызов `refreshSession()`** -- если `expires_at` равен null/0, условие `expiresAt - nowSec < 60` ВСЕГДА истинно, что вызывает ненужное обновление токена при каждом клике.
3. **Отсутствие retry при ошибке storage** -- в отличие от `externalDb.ts`, у storage-запросов нет механизма повторной попытки при 401.

### План исправления

#### `src/lib/openFile.ts` -- полная переработка

1. **Убрать отдельную функцию `ensureFreshToken`** и встроить логику проверки токена прямо в `openStorageFile`
2. **Добавить retry при ошибке**: если `createSignedUrl` вернул ошибку, принудительно обновить сессию через `refreshSession()` и попробовать ещё раз
3. **Написать сообщение в пустое окно** вместо попытки его закрыть: если произошла ошибка, записать в окно HTML-сообщение "Не удалось открыть файл. Закройте эту вкладку." -- это гарантирует, что пользователь увидит ошибку независимо от того, на какой вкладке он находится
4. **Добавить диагностическое логирование**: console.warn при ошибке createSignedUrl и при retry, чтобы в будущем было проще отлаживать

Итоговая логика:

```text
1. window.open('', '_blank')  -- синхронно, обход блокировщиков
2. createSignedUrl(filePath)  -- первая попытка с текущим токеном
3. Если ошибка:
   a. supabase.auth.refreshSession()  -- обновить токен
   b. createSignedUrl(filePath)  -- вторая попытка
4. Если успех: newWindow.location.href = signedUrl
5. Если ошибка после retry:
   a. Записать сообщение об ошибке В САМО ОКНО (не toast)
   b. Показать toast на оригинальной вкладке тоже
```

### Затронутые файлы

- **`src/lib/openFile.ts`** -- полная переработка с retry и записью ошибки в окно

### Результат

- Файлы открываются даже с просроченным токеном (retry с обновлением)
- При ошибке пользователь видит сообщение ПРЯМО В ОТКРЫТОМ ОКНЕ, а не about:blank
- Toast-уведомление тоже показывается на основной вкладке
- Диагностические логи помогут отладить будущие проблемы

